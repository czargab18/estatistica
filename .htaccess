RewriteEngine On

# Força HTTPS e 'www' para o domínio principal - OTIMIZADO
# Redireciona qualquer variação para https://www.estatistica.pro
RewriteCond %{HTTP_HOST} ^(www\.)?estatistica\.pro$ [NC]
RewriteCond %{HTTPS} off [OR]
RewriteCond %{HTTP_HOST} ^estatistica\.pro$ [NC]
RewriteRule ^ https://www.estatistica.pro%{REQUEST_URI} [L,R=301]

# Força HTTPS para subdomínios (exceto www) - SIMPLIFICADO
RewriteCond %{HTTPS} off
RewriteCond %{HTTP_HOST} ^[^.]+\.estatistica\.pro$ [NC]
RewriteCond %{HTTP_HOST} !^www\.estatistica\.pro$ [NC]
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Redireciona tentativas de acesso a /dev/ e /stage/
RewriteRule ^/dev/ https://www.estatistica.pro/errors/404/index.html [L,R=301]
RewriteRule ^/stage/ https://www.estatistica.pro/errors/404/index.html [L,R=301]
RewriteRule ^/newsroom/posts/ https://www.estatistica.pro/errors/404/index.html [L,R=301]
RewriteRule ^/books/ https://www.estatistica.pro/errors/404/index.html [L,R=301]
RewriteRule ^/backend/ https://www.estatistica.pro/errors/404/index.html [L,R=301]
RewriteRule ^/build/ https://www.estatistica.pro/errors/404/index.html [L,R=301]

# Página de ERRO STATUSCODE personalizada dominío principal
ErrorDocument 404 /errors/404/index.html
ErrorDocument 403 /errors/404/index.html
ErrorDocument 500 /errors/404/index.html
ErrorDocument 502 /errors/404/index.html
ErrorDocument 503 /errors/404/index.html
# Página de ERRO STATUSCODE personalizada qualquer dominío
RewriteCond %{REQUEST_FILENAME} !-f 
RewriteCond %{REQUEST_FILENAME} !-d 
RewriteRule ^(.*)$ https://www.estatistica.pro/errors/404/index.html [L,R=301]

# Configuração de cache para arquivos estáticos (1 ano)
SetEnvIf Request_URI "\.(ico|pdf|flv|jpg|jpeg|png|gif|swf|mp3|mp4)$" STATIC_FILES
Header set Cache-Control "public" env=STATIC_FILES
Header unset Last-Modified env=STATIC_FILES

# Configuração de cache para arquivos dinâmicos (6 meses)
SetEnvIf Request_URI "\.(html|js|css|xml|txt|xsl)$" DYNAMIC_FILES
Header set Cache-Control "max-age=15552000, must-revalidate" env=DYNAMIC_FILES

# =======================
# SECURITY HEADERS
# =======================

# Content Security Policy (CSP) - Previne ataques XSS
Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://code.jquery.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net; img-src 'self' data: https:; media-src 'self'; object-src 'none'; frame-src 'self'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests"

# HTTP Strict Transport Security (HSTS) - Força HTTPS
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

# X-Content-Type-Options - Previne MIME sniffing
Header always set X-Content-Type-Options "nosniff"

# X-Frame-Options - Previne clickjacking
Header always set X-Frame-Options "DENY"

# X-XSS-Protection - Proteção XSS (legacy, mas ainda útil)
Header always set X-XSS-Protection "1; mode=block"

# Referrer Policy - Controla informações do referrer
Header always set Referrer-Policy "strict-origin-when-cross-origin"

# Permissions Policy - Controla recursos do navegador
Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), fullscreen=(self), payment=()"

# Cross-Origin-Embedder-Policy - Isolamento de origem
Header always set Cross-Origin-Embedder-Policy "require-corp"

# Cross-Origin-Opener-Policy - Proteção contra window.opener
Header always set Cross-Origin-Opener-Policy "same-origin"

# Cross-Origin-Resource-Policy - Controla carregamento de recursos
Header always set Cross-Origin-Resource-Policy "same-origin"

# Remove headers que revelam informações do servidor
Header always unset Server
Header always unset X-Powered-By

#   fonte:
# - https://cwiki.apache.org/confluence/display/httpd/RewriteHTTPToHTTPS
# - https://www.askapache.pro/htaccess/ssl-example-usage-in-htaccess/
# - https://www.github.com/cesargabrielphd/
# - chat copilot vscode
# - ByteMonk HTTP Secure Headers Video: https://youtu.be/4bQeGUzHpOE