name: Atualizar Componentes nos Submodulos

on:
  push:
    branches: [main]
    paths: [
      "/ac/components/**/*.html",
    ]

permissions:
  contents: read
  pages: write
  id-token: write
concurrency:
  group: "pages"
  cancel-in-progress: false

environment:
  name: ENVIRONMENT
env:
  TOKEN_REPO_SYNC: ${{ secrets.TOKEN_REPO_SYNC }}
  USEREMAIL: ${{ secrets.USEREMAIL }}
  USERNAME: ${{ github.repository_owner }}

jobs:
  sync-components-to-submodules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repositÃ³rio principal
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.TOKEN_REPO_SYNC }}
          
      - name: Inicializar e atualizar submodules
        run: |
          git submodule update --init --recursive
          
      - name: Configurar Git
        run: |
          git config --global user.name "${{ env.USERNAME }}"
          git config --global user.email "${{ env.USEREMAIL }}"
          
      - name: Sincronizar componentes para submodules
        run: |
          # Lista dos submodules que devem receber os componentes
          SUBMODULES=("backend" "api" "wss" "books" "newshub")
          
          for submodule in "${SUBMODULES[@]}"; do
            echo "ğŸ”„ Processando submodule: $submodule"
            
            # Verificar se o submodule existe
            if [ -d "$submodule" ]; then
              cd "$submodule"
              
              # Fazer pull das Ãºltimas mudanÃ§as
              git pull origin main
              
              # Criar diretÃ³rio de componentes se nÃ£o existir
              mkdir -p ac/components
              
              # Copiar componentes do repositÃ³rio principal
              cp -r ../ac/components/* ac/components/ 2>/dev/null || echo "âš ï¸  Nenhum arquivo para copiar em $submodule"
              
              # Verificar se hÃ¡ mudanÃ§as
              if [ -n "$(git status --porcelain)" ]; then
                echo "ğŸ“ Commitando mudanÃ§as em $submodule"
                git add .
                git commit -m "ğŸ”„ Atualizar componentes do repositÃ³rio principal
                
                - SincronizaÃ§Ã£o automÃ¡tica via GitHub Actions
                - Componentes atualizados: $(date '+%Y-%m-%d %H:%M:%S')"
                
                # Push das mudanÃ§as
                git push origin main
                echo "âœ… Componentes sincronizados com sucesso em $submodule"
              else
                echo "â„¹ï¸  Nenhuma mudanÃ§a detectada em $submodule"
              fi
              
              cd ..
            else
              echo "âš ï¸  Submodule $submodule nÃ£o encontrado"
            fi
          done
          
      - name: Atualizar referÃªncias dos submodules no repositÃ³rio principal
        run: |
          # Atualizar as referÃªncias dos submodules no repositÃ³rio principal
          git add .
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "ğŸ“¦ Atualizar referÃªncias dos submodules
            
            - Componentes sincronizados em: $(date '+%Y-%m-%d %H:%M:%S')
            - Trigger: ${{ github.event.head_commit.message }}"
            git push origin main
            echo "âœ… ReferÃªncias dos submodules atualizadas"
          else
            echo "â„¹ï¸  Nenhuma mudanÃ§a nas referÃªncias dos submodules"
          fi