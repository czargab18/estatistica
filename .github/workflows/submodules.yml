# Código gerado/assistido por IA
name: Submodules Dispatch
description: Workflow para atualizar arquivos dos submódulos com o repositório Estatística.

on:
  workflow_dispatch:
  repository_dispatch:
    types: [atualizar-books, atualizar-newshub, atualizar-backend, atualizar-wss]

env:
  url: ${{ vars.URL }}
  TOKEN: ${{ secrets.TOKEN_REPO_SYNC }}
  USERNAME: ${{ github.repository_owner }}
  USEREMAIL: ${{ secrets.USEREMAIL }}

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  books:
    permissions:
      contents: write
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.action == 'atualizar-books' }}
    runs-on: ubuntu-latest
    environment:
      name: ENVIRONMENT
    steps:
      
      - name: Configura credenciais do Git para submódulos privados
        run: |
          git config --global url."https://${{ env.TOKEN }}:x-oauth-basic@github.com/".insteadOf "https://github.com/"
          
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ env.USERNAME }}/estatistica
          token: ${{ env.TOKEN }}
          ref: "stag"
          fetch-tags: true

      - name: Atualizar submodule 'books'
        run: |
          git submodule update --init books
      
      - name: Movendo de 'books/book' para 'book/'
        run: |
          rsync -av --delete books/book/ book/

        #5. padronizar livros par ao site via repositório backend
      - name: Atualizar submodule 'books'
        run: |
          git submodule update --init backend
      

      - name: Instalar o python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13.*'

      - name: Instalar dependências do backend
        run: |
          pip install -r ./backend/actions/run/requirements.txt ||
          pip install -r backend/actions/run/requirements.txt

      - name: Automação com 'backend/action/run/'
        run: |
          python ./backend/actions/run/site_html_manager.py --only-head --dynamic-head --path ./book/
          python ./backend/actions/run/site_html_manager.py --only-header --path ./book/
          python ./backend/actions/run/site_html_manager.py --only-footer --path ./book/

        #5. fazer o merge para o repositório estatística via branch: book
      - name: Commit e criar Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          base: stag # branch base onde a PR (de book para stag)
          branch: book
          delete-branch: true
          title: "book: atualiza novos livros Quarto renderizados"
          labels: |
            books
            quarto
            action
            needs-review
            automated-pr
          assignees: ${{ github.repository_owner }}
          reviewers: ${{ github.repository_owner  }}
          draft: false
          commit-message: |
            books: atualiza e padroniza livros renderizados

            Commit fonte: ${{ github.sha }}
            Data: $(date +'%Y-%m-%d %H:%M:%S UTC')

          body: |
            ## 📖 atualiza e padroniza livros renderizados pelo GitHub Actions

            Esta 'pull_request' contém a atualização dos livros renderizados, via GitHub Actions, a partir dos arquivos fonte em Quarto (.qmd) presentes na pasta `build/`.

            ### 📋 Detalhes da Renderização
            - **Commit fonte**: `${{ github.sha }}`
            - **Workflow**: `${{ github.run_id }}`
            - **Data**: $(date +'%Y-%m-%d %H:%M:%S UTC')
            - **Triggering commit**: `${{ github.event.head_commit.message }}`

            ### 📚 Livros Renderizados
            $(ls book 2>/dev/null | grep -E '^[A-Z]{3}[0-9]{4}' | sed 's/^/- 📖 /' || echo "- Nenhum livro renderizado")

            ## 👀 Review Checklist
            Por favor, verifique se todos os livros foram renderizados corretamente e estão prontos para publicação.:
            - [ ] 📖 Livros foram renderizados corretamente
            - [ ] 🎨 Formatação e estilos estão adequados
            - [ ] 🔗 Links internos funcionam
            - [ ] 📱 Layout é responsivo
            - [ ] 📁 Estrutura de pastas está organizada

            ---
            **⚠️ Esta PR requer aprovação manual do proprietário antes do merge.**

