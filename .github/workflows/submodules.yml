# Código gerado/assistido por IA
name: Submodules Dispatch
description: 
  Workflow para atualizar arquivos dos submódulos com o repositório Estatística.

on:
  workflow_dispatch:
  repository_dispatch:
    types: [atualizar-books, atualizar-newshub, atualizar-backend, atualizar-wss]

env:
  url: ${{ vars.URL }}
  TOKEN: ${{ secrets.TOKEN_REPO_SYNC }}
  USERNAME: ${{ github.repository_owner }}
  USEREMAIL: ${{ secrets.USEREMAIL }}

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  books:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.action == 'atualizar-books' }}
    runs-on: ubuntu-latest
    environment:
      name: ENVIRONMENT
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ env.USERNAME }}/estatistica
          token: ${{ env.TOKEN }}
          path: "estatistica"
          ref: "stag"
          fetch-tags: true

      - name: Configura credenciais do Git
        working-directory: estatistica
        run: |
          git config --global url."https://${{ env.TOKEN }}:x-oauth-basic@github.com/".insteadOf "https://github.com/"
          git remote set-url origin https://${{ env.TOKEN }}:x-oauth-basic@github.com/${{ github.repository }}.git
          git config user.name "${{ env.USERNAME }}"
          git config user.email "${{ env.USEREMAIL }}@users.noreply.github.com"

      - name: Atualizar submodule 'books'
        working-directory: estatistica
        run: |
          git submodule update --init books

      # PASSOS PARA AUTOMAÇÃO DO BOOKS PARA O REPOSITÓRIO ESTATÍSTICA
      # usar o repositório 'backend' com backend/action/book/ para a renderização
      # EM DESENVOLVIMENTO

      - name: Sincronizar pastas entre os repositórios
        working-directory: estatistica
        run: |
          ORIGIN="books/book"
          DESTINO="book"
          rsync -av --update "$DESTINO"/ "$ORIGIN"/ 

      - name: Faz commit e push dos livros renderizados
        working-directory: estatistica
        run: |
          git checkout -B book
          git add book/
          git commit -m "book: atualiza 'livros' a partir do submodule:books" || echo "Nada a commitar"
          git push --force origin book

      # O deploy será feito em um job onde eu puxo o site e submodulos.
      # EM DESENVOLVIMENTO