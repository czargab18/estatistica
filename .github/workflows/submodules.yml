# Código gerado/assistido por IA
name: Submodules Dispatch
description: 
  Workflow para atualizar arquivos dos submódulos com o repositório Estatística.

on:
  workflow_dispatch:
  repository_dispatch:
    types: [atualizar-books, atualizar-newshub, atualizar-backend, atualizar-wss]

env:
  url: ${{ vars.URL }}
  TOKEN: ${{ secrets.TOKEN_REPO_SYNC }}
  USERNAME: ${{ github.repository_owner }}
  USEREMAIL: ${{ secrets.USEREMAIL }}

jobs:
  books:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.action == 'atualizar-books' }}
    runs-on: ubuntu-latest
    environment:
      name: ENVIRONMENT
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ env.USERNAME }}/estatistica
          token: ${{ env.TOKEN }}
          path: "estatistica"
          ref: "main"

      - name: Configura credenciais do Git
        working-directory: estatistica
        run: |
          git config --global url."https://${{ env.TOKEN }}:x-oauth-basic@github.com/".insteadOf "https://github.com/"
          git remote set-url origin https://${{ env.TOKEN }}:x-oauth-basic@github.com/${{ github.repository }}.git
          git config user.name "${{ env.USERNAME }}"
          git config user.email "${{ env.USEREMAIL }}@users.noreply.github.com"

      - name: Atualizar submodule 'books'
        working-directory: estatistica
        run: |
          git submodule update --init books

      - name: Garante que a branch 'book' existe e faz checkout
        working-directory: estatistica
        run: |
          if ! git rev-parse --verify book >/dev/null 2>&1; then
            git checkout --orphan book
            git rm -rf .
            git commit --allow-empty -m "Cria branch book inicial"
            git push origin book
          else
            git checkout book
          fi

      - name: Sincronizar pastas entre os repositórios
        working-directory: estatistica
        run: |
          ORIGIN="books/book"
          DESTINO="estatistica/books"
          rsync -av --update "$DESTINO"/ "$ORIGIN"/ 

      - name: Faz commit e push dos livros renderizados
        working-directory: estatistica
        run: |
          git add book/
          git commit -m "book: atualiza 'livros' a partir do submodule:books" || echo "Nada a commitar"
          git push --force origin book

